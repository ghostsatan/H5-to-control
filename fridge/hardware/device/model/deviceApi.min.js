!function(e,t){e.DeviceAPI=e.DeviceAPI||{},e.DeviceAPI.load=function(o,n,a,r,i,c){"function"!=typeof r&&(i=arguments[3],c=arguments[4],r=void 0),t(e,o,n,a,r,i,c)}}(this,function(e,t,o,n,a,r,i){"use strict";var c=function(e){return"DeviceAPI : "+e},u={T01:"必须输入两个参数",T02:"方法名参数必须为string",T03:"第一个参数必须为Object实例",T04:"第二个参数必须为接口数组",T05:"第二个参数中对象必须为Interface实例",T06:"接口方法未定义",T07:"必须有string类型设备MAC",T08:"属性未定义",T09:"对象为空",T10:"00000",T11:"操作成功",T12:"13000",T13:"数据没有准备完成",T14:"属性不可写",T15:"非组命令属性",T16:"设备数据无变化"},f=f||function(e,t,o){if(arguments.length<2)throw console.log(c(u.T01)),new Error(c(u.T01));this.name=e;var n=this.methods=[];this.mask=o,t.forEach(function(e){if("string"!=typeof e)throw console.log(c(u.T02)),new Error(c(u.T02));n.push(e)})};f.prototype.ensureImplements=f.prototype.ensureImplements||function(e,t){if(arguments.length<2)throw console.log(c(u.T01)),new Error(c(u.T01));if(!(e instanceof Object))throw console.log(c(u.T03)),new Error(c(u.T03));if("[object Array]"!==Object.prototype.toString.call(t))throw console.log(c(u.T04)),new Error(c(u.T04));for(var o={},n=0;n<t.length;n++){var a=t[n];if(!(a instanceof f))throw console.log(c(u.T05)),new Error(c(u.T05));for(var r=0;r<a.methods.length;r++){var i=a.methods[r];if(!(e[i]||"function"==typeof e[i]&&"object"==typeof e[i]))throw console.log(c(i+u.T06)),new Error(c(i+u.T06));"undefined"!=typeof a.mask&&a.mask.indexOf(r)!==-1?(a.mask.shift(),o.init.prototype[i]=e[i]):o[i]=e[i]}}return o};var l={Base:new f("Base",["init","getAttr","deviceChange","deviceAttr","groupCommand","cacheData"],[2,3,4]),Operation:new f("Operation",["operation","setAttr","setGroupAttr","calculate","clearCache"])};f.prototype.backResult=function(e,o,n,a,r,i){if(e==t){if("string"!=typeof o)throw console.log(c(u.T07)),new Error(c(u.T07));"[object Array]"!==Object.prototype.toString.call(n)&&(a=arguments[2],r=arguments[3],i=arguments[4],n=["Base","Operation"]);var d=[];n.forEach(function(e){d.push(l[e])});var s=f.prototype.ensureImplements(DeviceAPI.createDevice.prototype[e],d);return s.typeId=e,s.mac=o,s.init.prototype.ready=!1,s.init.prototype.isSync=!0,s.init.prototype.isCachedData=!1,s.init.prototype.cacheDeviceData={},s.init.prototype.calculateData={},"function"==typeof a&&(s.init.prototype.subscribeCallback=a),s.init(r,i),s}throw console.log(c(e+u.T06)),new Error(c(e+u.T06))};var d={retCode:u.T10,retInfo:u.T11,data:""},s={groupCommand:n,deviceAttr:o};return s.dataCalculation=function(e,t,o,n){console.log(c("开始数据运算"));var a=e,r=a.init.prototype,f=function(){if("[object Array]"==Object.prototype.toString.call(n)){var e={};return e[n[0]]=t[n[0]],e}return t}(),l=[];for(var d in f){var s="",p={},v=f[d];if(v.issued){if(v.range){s=v.groupName;for(var g=0;g<v.range.length;g++){var y=v.range[g];if("undefined"!=typeof v[y]){var D,m=v[y];for(var D in m.commands)p[D]=m.commands[D]}else{var b,h={};if("undefined"==typeof r.deviceAttr[y])return console.log(c(y+u.T08));h[y]=r.deviceAttr[y].virtualData.value,b=r.deviceAttr[y].logic(a,h,!0);for(var D in b.commands)p[D]=b.commands[D]}}}else s=v.groupName,p=v.commands;o&&delete t[d],l.push({property:d,commands:p,groupName:s})}else{if("undefined"!=typeof i&&"undefined"!=typeof i.debugError){var T={};T.message=d+u.T14,i.debugError(T)}console.log(c(d+u.T14))}}return l},s.cacheData=function(e,t,o,n,a){console.log(c("开始缓存数据"));var r=e,i=r.init.prototype;if(0==t.length&&a&&"undefined"!=typeof a.range){console.log(c("输入的参数为空"));var f={};f[a.range[0]]=i.deviceAttr[a.range[0]].virtualData.value,t.push(f)}for(var l=0;l<t.length;l++){var d,s;for(d in t[l]);var p=i.deviceAttr[d];if("undefined"==typeof p||"undefined"==typeof p.virtualData||"undefined"==typeof p.virtualData.logic)return console.log(c(d+u.T08));if(s=a?a.groupName:d,i.cacheDeviceData[s]=i.cacheDeviceData[s]||{},a){if(console.log(c("组命令")),a.range.indexOf(d)==-1)return console.log(c(d+u.T15));var v=p.logic(r,t[l],!0,l===t.length-1?o:void 0,n);i.cacheDeviceData[s].range=a.range,i.cacheDeviceData[s].groupName=a.groupName,i.cacheDeviceData[s][d]={commands:v.commands,groupName:a.groupName},i.cacheDeviceData[s].issued=!0}else{console.log(c("单命令"));var v=p.logic(r,t[l],!0,o,n);p.virtualData.logic.writeable?(i.cacheDeviceData[d]={commands:v.commands,groupName:v.groupName},i.cacheDeviceData[s].issued=!0):i.cacheDeviceData[s].issued=!1}}},s.calculate=function(e){console.log(c("开始进行虚拟运算"));var t=this,o=t.init.prototype;o.calculateData=o.cacheDeviceData;var n=s.dataCalculation(t,o.calculateData);return console.log(c("获得虚拟运算结果 "+JSON.stringify(n))),e&&(console.log(c("清除运算结果")),o.calculateData={}),n},s.clearCache=function(){this.init.prototype.cacheDeviceData={}},s.deviceChange=function(e){console.log(c("初始化订阅")),updevice.subscribeDeviceChange(function(){},function(){},e.mac,function(t,o,n){console.log(c("订阅信息上报 "+JSON.stringify(o))),s.updateDeviceInfo(e,o,!1)})},s.getAttr=function(e){var t,o=this,n=o.init.prototype,a={},r=function(){for(var e in n.deviceData)a[e]=n.deviceData[e]};return n.ready?("[object Array]"===Object.prototype.toString.call(e)?e.forEach(function(e){"getAllProperty"===e?r():a[e]=n.deviceData[e]}):"undefined"==typeof e&&r(),t=s.cloneObject(d),t.data=a):t={retCode:u.T12,retInfo:u.T13,data:""},t},s.operation=function(e,t,o){"function"==typeof e&&(t=arguments[0],o=arguments[1],e=void 0);var n=this,a=n.init.prototype,r=s.dataCalculation(n,a.cacheDeviceData,!0,e);console.log(c("获取下发指令集 "+JSON.stringify(r))),r.length>0&&r.forEach(function(e){"undefined"!=typeof i&&"undefined"!=typeof i.debugIssued&&i.debugIssued(e),console.log(c("下发指令")),updevice.execDeviceOperation(function(e){console.log(c("下发指令成功")),t&&t(e)},function(t){"undefined"!=typeof i&&"undefined"!=typeof i.debugError&&(t.message="下发指令失败",i.debugError(t)),t.property=e.property,console.log(c("下发指令失败"+JSON.stringify(t))),o&&o(t)},n.mac,e.commands,e.groupName?e.groupName:"")}),a.isSync=!0},s.setAttr=function(e,t,o,n){"function"==typeof t&&(o=arguments[1],n=arguments[2],t=!1);var r=this,f=r.init.prototype,l=f.deviceAttr,p=!1;if(console.log(c("接收 setAttr 信息")),s.cacheData(r,e,function(e){console.log(c("setAttr 成功回调"));for(var t in l)f.deviceVirtualData[t]=l[t].virtualData;p=!0,"function"==typeof a&&(f.deviceVirtualData=a(f.deviceVirtualData,!0)),d.data=f.deviceVirtualData,"undefined"!=typeof i&&"undefined"!=typeof i.debugCallback&&i.debugCallback(d),o&&o(d)},function(e){var t={retCode:u.T12,retInfo:u.T14,data:e};console.log(c("setAttr 失败回调 "+JSON.stringify(t))),n&&n(t)}),t&&p){var v;for(v in e[0]);r.operation([v],function(e){o&&o(e)},function(e){n&&n(e)})}},s.setGroupAttr=function(e,t,o,n,r){"function"==typeof o&&(n=arguments[2],r=arguments[3],o=!1);var f=this,l=f.init.prototype,s=l.deviceAttr,p=!1;return console.log(c("接收 setGroupAttr 信息")),"undefined"==typeof l.groupCommand[e]?console.log(c(e+u.T08)):(console.log(c("执行 setGroupAttr logic")),l.groupCommand[e].logic(f,t,!1,function(e){console.log(c("setGroupAttr 成功回调"));for(var t in s)l.deviceVirtualData[t]=s[t].virtualData;p=!0,"function"==typeof a&&(l.deviceVirtualData=a(l.deviceVirtualData,!0)),d.data=l.deviceVirtualData,"undefined"!=typeof i&&"undefined"!=typeof i.debugCallback&&i.debugCallback(d),n&&n(d)},function(e){var t={retCode:u.T12,retInfo:u.T14,data:e};console.log(c("setGroupAttr 失败回调 "+JSON.stringify(t))),r&&r(t)}),o&&p&&f.operation([e],function(e){n&&n(e)},function(e){r&&r(e)}),void 0)},s.init=function(t,o){console.log(c("设备JS初始化"));var n=this,a=n.init.prototype;e.isTestParam&&"undefined"!=typeof r&&s.updateDeviceInfo(n,r.retData,!1,t,o),a.deviceChange(n),updevice.getDeviceInfo(function(e){console.log(c("getDeviceInfo 获取设备信息成功 "+JSON.stringify(e))),e.retCode===u.T10&&s.updateDeviceInfo(n,e.retData,!1,t,o)},function(e){throw"undefined"!=typeof i&&"undefined"!=typeof i.debugError&&(e.message="获取设备信息失败",i.debugError(e)),t&&t(e),console.log(c("getDeviceInfo 获取设备信息失败 "+JSON.stringify(e))),new Error(c(e.retInfo))},n.mac)},s.isEmptyObject=function(e){for(var t in e)return!0;return!1},s.cloneObject=function(e){if("[object Object]"!==Object.prototype.toString.call(e)||null==e)return e;var t=new Object;for(var o in e)t[o]=s.cloneObject(e[o]);return t},s.compareObject=function(e,t){if(typeof e!=typeof t)return!1;if("object"==typeof e){for(var o in e){if("undefined"==typeof t[o])return!1;if(!s.compareObject(e[o],t[o]))return!1}return!0}return e===t},s.updateDeviceInfo=function(e,t,o,n,r){function f(){p.data=s.cloneObject(t);var r={};for(var u in v)r[u]=v[u].logic(e,g,!1);if("function"==typeof a&&(r=a(r,!1)),"undefined"==typeof p.virtualDevice&&o&&(p.virtualDevice={},p.virtualDevice.data=s.cloneObject(t),p.virtualDevice.deviceData=s.cloneObject(r),p.virtualDevice.deviceVirtualData=s.cloneObject(r)),p.deviceData=r,s.isEmptyObject(p.cacheDeviceData)||(p.isSync=!0),"undefined"==typeof p.deviceVirtualData||p.isSync){for(var f in v)v[f].virtualData=s.cloneObject(v[f].data);p.isSync=!1,p.deviceVirtualData=s.cloneObject(r)}return d.data=s.cloneObject(r),console.log(c("JS解析后数据 "+JSON.stringify(d))),"undefined"!=typeof i&&"undefined"!=typeof i.debugParam&&i.debugParam(l,d.data),"function"==typeof n?n(d):p.subscribeCallback(d)}console.log(c("设备上报信息 "+JSON.stringify(t)));var l=s.cloneObject(t);if(!s.isEmptyObject(t.attributes))return console.log(c("attributes"+u.T09));if(!s.isEmptyObject(t.deviceInfo))return console.log(c("deviceInfo"+u.T09));var p=e.init.prototype,v=p.deviceAttr;p.ready=!0,"undefined"!=typeof t.connection?(console.log(c("在线状态 connection:"+t.connection)),t.attributes.online="READY"==t.connection):(t.attributes.online="undefined"!=typeof t.deviceInfo.status&&!!t.deviceInfo.status.online,console.log(c("在线状态 online:"+t.attributes.online))),t.attributes.alarms="undefined"!=typeof t.alarms?t.alarms:[];var g=t.attributes;if(p.isCachedData&&"undefined"!=typeof p.data){if(!r&&s.compareObject(p.data,t))return console.log(c(u.T16));f()}else p.isCachedData=!0,f()},e.DeviceAPI.createDevice=e.DeviceAPI.createDevice||f.prototype.backResult,e.DeviceAPI.createDevice.prototype[t]=s,e.DeviceAPI});